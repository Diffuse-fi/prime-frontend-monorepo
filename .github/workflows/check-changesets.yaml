name: Check changesets

on:
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  check-changesets:
    name: Check Changesets
    runs-on: ubuntu-latest
    steps:
      - name: Clone repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install dependencies
        uses: ./.github/actions/install-dependencies
        with:
          setup-node: true
          audit: false

      - name: Fetch base branch
        shell: bash
        run: git fetch origin ${{ github.base_ref }} --depth=1

      - name: Check for pending Changesets
        id: changesets
        shell: bash
        continue-on-error: true
        run: |
          set +e
          npm run check:changesets -- --since=${{ github.event.pull_request.base.sha }}
          code=$?
          echo "exit_code=$code" >> "$GITHUB_OUTPUT"
          exit 0

      - name: HOW TO FIX MISSING CHANGESET
        if: steps.changesets.outputs.exit_code != '0'
        shell: bash
        run: |
          echo "::group::Changesets required"
          echo "This PR changes one or more packages but does not include a Changeset."
          echo ""
          echo "What you need to do:"
          echo "1) Run: npx changeset add"
          echo "2) Pick the package(s) you changed"
          echo "3) Choose bump type:"
          echo "   - patch: bugfix/internal change, no API change"
          echo "   - minor: new feature, backwards compatible"
          echo "   - major: breaking change"
          echo "4) Write a short, user-facing summary"
          echo "5) Commit the generated file under .changeset/*.md"
          echo ""
          echo "If this PR should not trigger a release:"
          echo "Run: npx changeset add --empty"
          echo "Then commit the generated empty changeset."
          echo "::endgroup::"
          {
            echo "## Changesets required"
            echo ""
            echo "This PR changes one or more packages but does not include a Changeset."
            echo ""
            echo "### Fix"
            echo "Run \`npx changeset add\` and commit the generated \`.changeset/*.md\` file."
            echo ""
            echo "### No release needed?"
            echo "Run \`npx changeset add --empty\` and commit it."
          } >> "$GITHUB_STEP_SUMMARY"
          exit 1
